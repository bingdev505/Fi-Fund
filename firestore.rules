/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model, ensuring that users can only access data associated with their own user ID.
 *
 * Data Structure:
 * All data is nested under /users/{userId}, with subcollections for transactions, debts, and bank accounts. This hierarchical structure simplifies access control.
 * /users/{userId} - User profile information
 * /users/{userId}/transactions/{transactionId} - Financial transactions
 * /users/{userId}/debts/{debtId} - Debt information
 * /users/{userId}/bankAccounts/{accountId} - Bank account details
 *
 * Key Security Decisions:
 * - User listing is disallowed to prevent unauthorized enumeration of user accounts.
 * - All write operations are restricted to the owning user.
 *
 * Denormalization for Authorization:
 * The `userId` field within each document is critically important for authorization. It must match the `userId` in the path.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures the user profile document. Users can only read and modify their own profile.
     * @path /users/{userId}
     * @allow (create) - User A can create their own profile if request.auth.uid == userId.
     * @allow (get, update, delete) - User A can access their own profile if request.auth.uid == userId.
     * @deny (create) - User A cannot create a profile for User B.
     * @deny (get, update, delete) - User A cannot access User B's profile.
     * @principle Enforces document ownership.  Validates userId on create. Enforces immutable userId on updates.
     */
    match /users/{userId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isExistingOwner(userId) {
        return isSignedIn() && isOwner(userId) && resource.data != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if false; // Prevent user enumeration

      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures transaction documents under a user's profile. Only the owner can manage transactions.
     * @path /users/{userId}/transactions/{transactionId}
     * @allow (create) - User A can create a transaction under their profile (request.auth.uid == userId).
     * @allow (get, list, update, delete) - User A can manage transactions under their profile.
     * @deny (create) - User A cannot create a transaction under User B's profile.
     * @deny (get, list, update, delete) - User A cannot manage transactions under User B's profile.
     * @principle Enforces document ownership and path consistency. Validates userId on create and enforces immutable userId on updates.
     */
    match /users/{userId}/transactions/{transactionId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

       function isExistingOwner(userId) {
        return isSignedIn() && isOwner(userId) && resource.data != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures debt documents under a user's profile. Only the owner can manage debts.
     * @path /users/{userId}/debts/{debtId}
     * @allow (create) - User A can create a debt under their profile (request.auth.uid == userId).
     * @allow (get, list, update, delete) - User A can manage debts under their profile.
     * @deny (create) - User A cannot create a debt under User B's profile.
     * @deny (get, list, update, delete) - User A cannot manage debts under User B's profile.
     * @principle Enforces document ownership and path consistency. Validates userId on create and enforces immutable userId on updates.
     */
    match /users/{userId}/debts/{debtId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

       function isExistingOwner(userId) {
        return isSignedIn() && isOwner(userId) && resource.data != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Secures bank account documents under a user's profile. Only the owner can manage bank accounts.
     * @path /users/{userId}/bankAccounts/{accountId}
     * @allow (create) - User A can create a bank account under their profile (request.auth.uid == userId).
     * @allow (get, list, update, delete) - User A can manage bank accounts under their profile.
     * @deny (create) - User A cannot create a bank account under User B's profile.
     * @deny (get, list, update, delete) - User A cannot manage bank accounts under User B's profile.
     * @principle Enforces document ownership and path consistency. Validates userId on create and enforces immutable userId on updates.
     */
    match /users/{userId}/bankAccounts/{accountId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return request.auth.uid == userId;
      }

       function isExistingOwner(userId) {
        return isSignedIn() && isOwner(userId) && resource.data != null;
      }

      allow get: if isSignedIn() && isOwner(userId);
      allow list: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}