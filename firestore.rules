/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for financial data.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles. Only the authenticated user can read/write their own profile.
 * - /users/{userId}/transactions/{transactionId}: Stores transaction data (income/expenses). Only the owning user can access these.
 * - /users/{userId}/debts/{debtId}: Stores debt information (creditors/debtors). Only the owning user can access these.
 * - /users/{userId}/bankAccounts/{accountId}: Stores bank account details. Only the owning user has access.
 *
 * Key Security Decisions:
 * - Users can only access data under their own user ID.
 * - Listing collections is restricted to the owner.
 * - Write operations are validated to ensure data consistency between document IDs and the user ID in the path.
 *
 * Denormalization for Authorization:
 * - Each document includes a 'userId' field to simplify ownership checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to user profile documents.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' can create their profile document.
     * @allow (get, update, delete) User with UID 'user123' can read/update/delete their own profile.
     * @deny (get, update, delete) User with UID 'otherUser' cannot read/update/delete the profile of user 'user123'.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.id == userId;
      allow update: if isOwner(userId) && resource.data.id == userId;
      allow delete: if isOwner(userId) && resource.data.id == userId;
    }

    /**
     * @description Controls access to transaction documents within a user's profile.
     * @path /users/{userId}/transactions/{transactionId}
     * @allow (create) User with UID 'user123' can create a transaction under their profile.
     * @allow (get, update, delete) User with UID 'user123' can read/update/delete their own transactions.
     * @deny (get, update, delete) User with UID 'otherUser' cannot read/update/delete transactions of user 'user123'.
     * @principle Enforces document ownership for transactions.
     */
    match /users/{userId}/transactions/{transactionId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isSignedIn() {
        return request.auth != null;
      }
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && resource.data.userId == userId;
      allow delete: if isOwner(userId) && resource.data.userId == userId;
    }

    /**
     * @description Controls access to debt documents within a user's profile.
     * @path /users/{userId}/debts/{debtId}
     * @allow (create) User with UID 'user123' can create a debt entry under their profile.
     * @allow (get, update, delete) User with UID 'user123' can read/update/delete their own debt entries.
     * @deny (get, update, delete) User with UID 'otherUser' cannot read/update/delete debt entries of user 'user123'.
     * @principle Enforces document ownership for debts.
     */
    match /users/{userId}/debts/{debtId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && resource.data.userId == userId;
      allow delete: if isOwner(userId) && resource.data.userId == userId;
    }

    /**
     * @description Controls access to bank account documents within a user's profile.
     * @path /users/{userId}/bankAccounts/{accountId}
     * @allow (create) User with UID 'user123' can create a bank account under their profile.
     * @allow (get, update, delete) User with UID 'user123' can read/update/delete their own bank accounts.
     * @deny (get, update, delete) User with UID 'otherUser' cannot read/update/delete bank accounts of user 'user123'.
     * @principle Enforces document ownership for bank accounts.
     */
    match /users/{userId}/bankAccounts/{accountId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }

      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isOwner(userId) && resource.data.userId == userId;
      allow delete: if isOwner(userId) && resource.data.userId == userId;
    }
  }
}